# 04_indexing_storage.md - 索引與儲存申論題完全解析

## 📊 題目總覽與統計

**索引與儲存 (Indexing & Storage)** 雖然題數較少，但往往是「效能調校」與「實體設計」的關鍵考題。掌握此章節可以展現你對資料庫底層運作的深刻理解。

- **總題數**：約 23 題（佔比約 10-15%）
- **出題頻率**：⭐⭐⭐（間歇性出現）
- **難度**：⭐⭐⭐⭐（涉及資料結構與演算法，較為抽象）
- **主要題型**：
    1. **索引結構**：B-Tree vs B+ Tree、Hash Index。
    2. **索引類型**：叢集索引 (Clustered) vs 非叢集索引 (Non-Clustered)。
    3. **儲存技術**：RAID 等級與特性。
    4. **檔案組織**：循序檔 (Sequential) vs 雜湊檔 (Hash)。

---

## 🎯 申論題答題黃金架構

### 1. 比較題型 (例如：B+ Tree vs Hash)

> **一、定義說明**
> (分別簡述兩者的定義與核心運作原理)
>
> **二、比較分析 (表格)**
> (使用表格列出：查詢速度、範圍查詢支援、空間利用率、適用場景)
>
> **三、結論**
> (總結在什麼情況下該選用哪一種技術)

### 2. 結構說明題型 (例如：解釋 B+ Tree)

> **一、結構特徵**
> (說明節點組成：Internal Node, Leaf Node, Pointers)
>
> **二、運作機制**
> (說明搜尋、插入、分裂的過程)
>
> **三、優點與應用**
> (說明為何資料庫愛用此結構，例如：磁碟 I/O 最佳化)

---

## 📝 實戰解析：精選題型詳解

### 【題型一】B+ Tree 結構與應用

#### 📌 原題：111年關務特考三等

> **題目**：
> 根據 `Mid` 欄位定義一個名為 `MyIndex` 的 **B+-tree** 索引。
> ⑴ 說明 `MyIndex` 的樹狀結構（內部節點、葉節點、特性）。
> ⑵ 說明系統如何利用該索引提升 `select Name from MEMBER where Mid = 'M001'` 的效能。

#### 💡 解析與擬答

**⑴ B+ Tree 樹狀結構說明**

B+ Tree 是一種平衡樹 (Balanced Tree)，其結構特性如下：

1. **內部節點 (Internal Nodes)**：
    - 僅儲存**索引鍵值 (Key)** 與**指標 (Pointer)**，不儲存實際資料。
    - 用來引導搜尋路徑，將搜尋範圍快速縮小。
2. **葉節點 (Leaf Nodes)**：
    - 儲存**所有的鍵值**與**資料指標 (Data Pointer)**（指向實際資料列）。
    - 所有葉節點透過**雙向鏈結 (Doubly Linked List)** 串連，方便進行範圍查詢 (Range Query)。
    - 所有葉節點都在同一層 (Balanced)，保證搜尋時間複雜度為 O(log N)。
3. **特性**：
    - **高扇出 (High Fan-out)**：每個節點可容納大量鍵值，降低樹的高度，減少磁碟 I/O 次數。

**⑵ 查詢效能提升機制**

針對 SQL：`SELECT Name FROM MEMBER WHERE Mid = 'M001'`

1. **搜尋過程**：
    - 系統從 B+ Tree 的**根節點 (Root)** 開始，比較 `M001` 與節點內的鍵值。
    - 依據比較結果，沿著指標向下走訪至下一層節點。
    - 重複此步驟直到抵達**葉節點 (Leaf Node)**。
2. **資料存取**：
    - 在葉節點中找到 `M001`，取得對應的資料指標 (RID)。
    - 直接根據 RID 讀取硬碟中的該筆資料列 (Row)，取出 `Name` 欄位。
3. **效能優勢**：
    - 若無索引，需進行**全表掃描 (Full Table Scan)**，成本為 O(N)。
    - 使用 B+ Tree 索引，僅需讀取少數幾個節點 (樹高通常為 3-4 層)，成本大幅降低為 O(log N)。

---

### 【題型二】雜湊 vs 循序 (Hash vs Sequential)

#### 📌 原題：112年一般警察特考三等

> **題目**：
> 比較 **雜湊法索引 (Hashing)** 與 **循序檔 (Sequential File)**：
> ⑴ 最壞資料找尋時間
> ⑵ 儲存空間利用率
> ⑶ 資料是否需排序
> ⑷ 是否適合 Linked List

#### 💡 解析與擬答

| 比較項目 | 雜湊法索引 (Hashing) | 循序檔 (Sequential File) |
| :--- | :--- | :--- |
| **⑴ 最壞搜尋時間** | **O(N)** <br> (發生嚴重碰撞 Collision 時退化為鏈結串列搜尋) | **O(log N)** <br> (若使用二元搜尋法 Binary Search) |
| **⑵ 空間利用率** | **較低** <br> (需預留 Bucket 空間以減少碰撞，會有內部破碎) | **較高** <br> (資料緊密排列，無多餘空間浪費) |
| **⑶ 是否需排序** | **否** <br> (資料依雜湊函數計算位置隨機存放) | **是** <br> (資料依鍵值順序存放) |
| **⑷ Linked List 適合度** | **適合** <br> (常用於解決碰撞問題，如 Chaining 法) | **不適合** <br> (循序檔通常強調連續實體儲存以利批次處理) |

---

### 【題型三】RAID 等級與特性

#### 📌 原題：107年調查局三等

> **題目**：
> 磁碟陣列 RAID 技術可用來提供容錯功能，試描述不同等級 RAID 的特性及優缺點。

#### 💡 解析與擬答

RAID (Redundant Array of Independent Disks) 利用多顆硬碟提升效能與可靠性。

**1. RAID 0 (Striping / 分割)**

- **特性**：將資料分散寫入多顆硬碟。
- **優點**：讀寫效能最高 (並行處理)。
- **缺點**：**無容錯能力**，任一顆硬碟壞掉，資料全毀。

**2. RAID 1 (Mirroring / 鏡像)**

- **特性**：將資料完全複製到另一顆硬碟。
- **優點**：容錯能力佳 (可壞一顆)，讀取速度快 (可同時讀)。
- **缺點**：**空間利用率低 (50%)**，成本高。

**3. RAID 5 (Striping with Parity / 分散同位元)**

- **特性**：資料與同位元檢查碼 (Parity) 分散儲存在所有硬碟。
- **優點**：兼具容錯 (可壞一顆) 與效能，空間利用率較 RAID 1 高 (N-1/N)。
- **缺點**：寫入效能稍差 (需計算 Parity)。

**4. RAID 10 (RAID 1 + RAID 0)**

- **特性**：先做 Mirror (RAID 1) 再做 Striping (RAID 0)。
- **優點**：兼具高效能與高容錯。
- **缺點**：成本最高 (空間利用率 50%)。

---

### 【題型四】叢集 vs 非叢集索引

#### 📌 原題：106年地方特考三等

> **題目**：
> 請解釋 **叢集索引 (Clustered Index)** 與 **非叢集索引 (Non-Clustered Index)** 的意義與差別。

#### 💡 解析與擬答

這題是索引觀念的經典題，核心在於「實體排序」。

**1. 叢集索引 (Clustered Index)**

- **意義**：資料表的**實體資料排列順序**與索引鍵值的順序**相同**。
- **特點**：
  - 一個資料表**只能有一個**叢集索引 (因為實體排序只能有一種)。
  - 葉節點就是**實際的資料頁 (Data Page)**。
  - 通常預設建立在 **Primary Key** 上。
- **優點**：範圍查詢 (Range Query) 速度極快。

**2. 非叢集索引 (Non-Clustered Index)**

- **意義**：索引的邏輯順序與資料的實體儲存順序**無關**。
- **特點**：
  - 一個資料表可以有**多個**非叢集索引。
  - 葉節點儲存的是**指向實際資料的指標 (Row ID 或 Clustered Key)**。
- **優點**：適合用於輔助查詢特定欄位，不影響資料實體結構。

**差異總結**：

- **數量**：叢集索引限 1 個；非叢集索引可多個。
- **內容**：叢集索引葉節點是資料本身；非叢集索引葉節點是指標。
- **速度**：叢集索引通常比非叢集索引快 (省去一次指標跳轉)。

---

## 📚 其他重要題型速覽

1. **雜湊碰撞處理 (Collision Resolution)**
    - **Chaining (鏈結法)**：Bucket 後面掛 Linked List。
    - **Open Addressing (開放定址法)**：Linear Probing (線性探測) 找下一個空位。

2. **動態雜湊 (Dynamic Hashing)**
    - **Extendible Hashing (可擴展雜湊)**：使用 Directory 與 Global/Local Depth 來動態調整 Bucket 數量，避免傳統雜湊需重新雜湊 (Re-hashing) 的高成本。

---

## ⚔️ 答題總策略

### ✅ 關鍵字得分技巧

- 寫到 **B+ Tree** 必提：**「平衡樹」、「高度低」、「減少 I/O」、「適合範圍查詢」**。
- 寫到 **Hash** 必提：**「O(1) 搜尋」、「碰撞處理」、「不適合範圍查詢」**。
- 寫到 **Clustered Index** 必提：**「實體排序」、「只能有一個」**。

### 🎨 圖解加分

- 遇到索引結構題，**務必畫圖**。
- 畫 B+ Tree 時，清楚區分 Internal Node (只有 Key) 與 Leaf Node (Key + Data)，並畫出 Leaf 之間的箭頭 (Linked List)。

---

## 📖 推薦練習題目

### ★★★ 必練 (基礎)

1. **111 關務三等** (B+ Tree)：解釋結構與查詢過程。
2. **106 地特三等** (Clustered Index)：比較叢集與非叢集。

### ★★ 進階 (比較)

1. **112 一般警察** (Hash vs Sequential)：多面向比較。
2. **107 調查局** (RAID)：各等級優缺點。

---

> **💡 媽媽的備忘錄**：
> 索引就像是書的「目錄」。
>
> - **Clustered Index** 就像字典的單字排序，整本書就是照著它排的，所以只能有一個。
> - **Non-Clustered Index** 就像書後面的「索引頁」，照筆畫排，但找到後要翻回內文才看得到內容。
>
> 考試時如果忘記 B+ Tree 細節，記得畫出「矮矮胖胖」的樹，葉子手牽手 (Linked List) 就對了！🌳
